<div class="spinner-overlay" *ngIf="loading">
  <div class="spinner">
    <mat-spinner></mat-spinner>
  </div>
</div>

<app-navigation>
  <div class="container">
    <h2>Registrar paquete</h2>
    <br>
    <div class="container">
      <form [formGroup]="editRemitente">
        <!-- PARA EL DATALIST, NO BORREN NADA HPS -->
        <!-- <div class="row">
          <div class="col">
            <input type="text" list="frutas" (input)="filtrarOpciones($event)" class="form-control">
            <datalist id="frutas">
              <option *ngFor="let r of cliente" [value]="r"></option>
            </datalist>
          </div>
  
          <div class="col">
            <div class="form-group">
              <label for="nombreCliente">Nombre<b style="color: red;">*</b></label>
              <input type="text" formControlName="documentoCliente" class="form-control"
                placeholder="Ingrese el nombre del remitente" [ngClass]="{
                  'is-invalid': editRemitente.get('documentoCliente')?.invalid && (editRemitente.get('documentoCliente')?.touched || editRemitente.get('documentoCliente')?.dirty),
                  'is-valid': editRemitente.get('documentoCliente')?.valid && (editRemitente.get('documentoCliente')?.touched || editRemitente.get('documentoCliente')?.dirty)
                }" (input)="filtrarRemitentes($event)">
              <datalist id="remitentes-list">
                <option *ngFor="let remi of remitentesFiltrados" [value]="remi.documentoCliente">
                  {{ remi.nombreCliente }}
                </option>
              </datalist>
              <div *ngIf="editRemitente.get('documentoCliente')?.errors?.['required']" class="invalid-feedback">
                Este campo es obligatorio.
              </div>
            </div>
          </div>
        </div> -->

        <div class="row">
          <h4>Remitente
            <button class="btn btn-circle" type="button" (click)="openAddClienteDialog()">
              <span class="material-icons" style="color: green;">add</span>
            </button>
          </h4>
          <div class="col">
            <div class="form-group">
              <label for="documentoCliente">Nombre<b style="color: red;">*</b></label>
              <mat-select class="form-control" formControlName="documentoCliente" placeholder="---SELECCIONE---"
                [ngClass]="{
                'is-invalid': editRemitente.get('documentoCliente')?.invalid && (editRemitente.get('documentoCliente')?.touched || editRemitente.get('documentoCliente')?.dirty),
                'is-valid': editRemitente.get('documentoCliente')?.valid && (editRemitente.get('documentoCliente')?.touched || editRemitente.get('documentoCliente')?.dirty)
              }" (selectionChange)="onRemitenteSelectionChange($event)">
                <mat-option *ngFor="let remi of remitente" [value]="remi.documentoCliente">
                  {{ remi.nombreCliente }}
                </mat-option>
              </mat-select>
              <div *ngIf="editRemitente.get('documentoCliente')?.errors?.['required']" class="invalid-feedback">
                Este campo es obligatorio.
              </div>
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label for="exampleFormControlInput1">N° de Documento</label>
              <input type="text" class="form-control" [value]="selectedRemitente?.documentoCliente" disabled>
            </div>
          </div>
        </div>
        <hr style="border-top: 1px solid #ccc; margin: 5px 0;">
          <div class="row">
            <div class="col">
              <!-- Campo de Correo -->
              <div class="form-group">
                <label for="exampleFormControlInput1">Correo</label>
                <input type="text" class="form-control" formControlName="correoCliente" [ngClass]="{
                  'is-invalid': editRemitente.get('correoCliente')?.invalid && (editRemitente.get('correoCliente')?.touched || editRemitente.get('correoCliente')?.dirty),
                  'is-valid': editRemitente.get('correoCliente')?.valid
                }" />
                <div *ngIf="editRemitente.get('correoCliente')?.errors?.['pattern']" class="invalid-feedback">
                  Correo inválido.
                </div>
                <div *ngIf="editRemitente.get('correoCliente')?.errors?.['required']" class="invalid-feedback">
                  Este campo es obligatorio.
                </div>
              </div>
            </div>
          
            <div class="col">
              <!-- Campo de Teléfono y Botón de Edición -->
              <div class="d-flex align-items-center">
                <div class="form-group flex-grow-1">
                  <label for="exampleFormControlInput1">Telefono</label>
                  <input type="text" class="form-control" formControlName="telefonoCliente" [ngClass]="{
                    'is-invalid': editRemitente.get('telefonoCliente')?.invalid && (editRemitente.get('telefonoCliente')?.touched || editRemitente.get('telefonoCliente')?.dirty),
                    'is-valid': editRemitente.get('telefonoCliente')?.valid
                  }" />
                  <div *ngIf="editRemitente.get('telefonoCliente')?.errors?.['pattern']" class="invalid-feedback">
                    Teléfono inválido, debe contener 10 dígitos numéricos.
                  </div>
                  <div *ngIf="editRemitente.get('telefonoCliente')?.errors?.['required']" class="invalid-feedback">
                    Este campo es obligatorio.
                  </div>
                </div>
                <button class="btn btn-circle btn-update btn-margin" type="button" title="Actualizar correo y telefono" (click)="editRemi(editRemitente.value)">
                  <span class="material-icons">edit</span>
                </button>
              </div>
            </div>
          </div>
          
        <hr style="border-top: 1px solid #ccc; margin: -5px 0;"><br><br>
      </form>

      <form [formGroup]="newForm" (ngSubmit)="postForm(newForm.value); ">
        <div class="row">
          <h4>Destinatario</h4>
          <div class="col">
            <div class="form-group">
              <label for="exampleFormControlInput1">N° de Documento <b style="color: red;">*</b></label>
              <input type="text" class="form-control" formControlName="documentoDestinatario" [ngClass]="{
                'is-invalid': newForm.get('documentoDestinatario')?.invalid && (newForm.get('documentoDestinatario')?.touched || newForm.get('documentoDestinatario')?.dirty),
                'is-valid': newForm.get('documentoDestinatario')?.valid && newForm.get('documentoDestinatario')?.dirty
              }" />
              <div *ngIf="newForm.get('documentoDestinatario')?.errors?.['pattern']" class="invalid-feedback">
                Documento inválido, mínimo 7 y máximo 10 dígitos numéricos.
              </div>
              <div *ngIf="newForm.get('documentoDestinatario')?.errors?.['required']" class="invalid-feedback">
                Este campo es obligatorio.
              </div>
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label for="documentoDestinatario">Nombre<b style="color: red;">*</b></label>
              <input list="destinatarios" class="form-control" formControlName="nombreDestinatario" [ngClass]="{
                'is-invalid': newForm.get('nombreDestinatario')?.invalid && (newForm.get('nombreDestinatario')?.touched || newForm.get('nombreDestinatario')?.dirty),
                'is-valid': newForm.get('nombreDestinatario')?.valid}">
              <div *ngIf="newForm.get('nombreDestinatario')?.errors?.['required']" class="invalid-feedback">
                Este campo es obligatorio.
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <div class="form-group">
              <label for="exampleFormControlInput1">Correo<b style="color: red;">*</b></label>
              <input type="text" class="form-control" formControlName="correoDestinatario" [ngClass]="{
                'is-invalid': newForm.get('correoDestinatario')?.invalid && (newForm.get('correoDestinatario')?.touched || newForm.get('correoDestinatario')?.dirty),
                'is-valid': newForm.get('correoDestinatario')?.valid 
              }" />
              <div *ngIf="newForm.get('correoDestinatario')?.errors?.['pattern']" class="invalid-feedback">
                Correo inválido.
              </div>
              <div *ngIf="newForm.get('correoDestinatario')?.errors?.['required']" class="invalid-feedback">
                Este campo es obligatorio.
              </div>
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label for="exampleFormControlInput1">Telefono<b style="color: red;">*</b></label>
              <input type="text" class="form-control" formControlName="telefonoDestinatario" [ngClass]="{
                'is-invalid': newForm.get('telefonoDestinatario')?.invalid && (newForm.get('telefonoDestinatario')?.touched || newForm.get('telefonoDestinatario')?.dirty),
                'is-valid': newForm.get('telefonoDestinatario')?.valid
              }" />
              <div *ngIf="newForm.get('telefonoDestinatario')?.errors?.['pattern']" class="invalid-feedback">
                Teléfono inválido, debe contener 10 dígitos numéricos.
              </div>
              <div *ngIf="newForm.get('telefonoDestinatario')?.errors?.['required']" class="invalid-feedback">
                Este campo es obligatorio.
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="form-group">
            <label for="">Direccion<b style="color: red;">*</b></label>
            <input type="text" class="form-control" formControlName="codigoQrPaquete" #inputPlaces [ngClass]="{
                'is-invalid': newForm.get('codigoQrPaquete')?.invalid && (newForm.get('codigoQrPaquete')?.touched || newForm.get('codigoQrPaquete')?.dirty),
                'is-valid': newForm.get('codigoQrPaquete')?.valid 
              }" />
            <div *ngIf="newForm.get('documentoDestinatario')?.errors?.['required']" class="invalid-feedback">
              Este campo es obligatorio.
            </div>
          </div>
        </div>
        <hr style="border-top: 1px solid #ccc; margin: -5px 0;"><br><br>

        <div class="row">
          <h4>Paquete</h4>
          <div class="col">
            <div class="form-group">
              <label for="exampleFormControlInput1">Peso en KG<b style="color: red;">*</b></label>
              <input type="text" class="form-control" formControlName="pesoPaquete" [ngClass]="{
              'is-invalid': newForm.get('pesoPaquete')?.invalid && (newForm.get('pesoPaquete')?.touched || newForm.get('pesoPaquete')?.dirty),
              'is-valid': newForm.get('pesoPaquete')?.valid && newForm.get('pesoPaquete')?.dirty
            }">
              <div *ngIf="newForm.get('pesoPaquete')?.errors?.['pattern']" class="invalid-feedback">
                Campo inválido, maximo 3 digitos numéricos y no más de 2 decimales.
              </div>
              <div *ngIf="newForm.get('pesoPaquete')?.errors?.['required']" class="invalid-feedback">
                Este campo es obligatorio.
              </div>
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label for="">Tamaño</label>
              <mat-select class="form-control" formControlName="idTamano" placeholder="---SELECCIONE---" [ngClass]="{
              'is-invalid': newForm.get('idTamano')?.invalid && (newForm.get('idTamano')?.touched || newForm.get('idTamano')?.dirty),
              'is-valid': newForm.get('idTamano')?.valid && (newForm.get('idTamano')?.touched || newForm.get('idTamano')?.dirty)
            }">
                <mat-option *ngFor="let t of tamanos" [value]="t.idTamano">
                  {{ t.tamanoPaquete }}
                </mat-option>
              </mat-select>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <div class="form-group">
              <label for="">Tipo<b style="color: red;">*</b></label>
              <mat-select class="form-control" formControlName="idTipo" placeholder="---SELECCIONE---" [ngClass]="{
              'is-invalid': newForm.get('idTipo')?.invalid && (newForm.get('idTipo')?.touched || newForm.get('idTipo')?.dirty),
              'is-valid': newForm.get('idTipo')?.valid && (newForm.get('idTipo')?.touched || newForm.get('idTipo')?.dirty)
            }">
                <mat-option *ngFor="let t of tipos" [value]="t.idTipo">
                  {{ t.tipoPaquete }}
                </mat-option>
              </mat-select>
              <div *ngIf="newForm.get('idTipo')?.errors?.['required']" class="invalid-feedback">
                Este campo es obligatorio.
              </div>
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label for="exampleFormControlInput1">Fecha aproximada de entrega<b style="color: red;">*</b></label>
              <input type="date" class="form-control" [min]="getFechAct()" formControlName="fechaAproxEntrega"
                [ngClass]="{
              'is-invalid': newForm.get('fechaAproxEntrega')?.invalid && (newForm.get('fechaAproxEntrega')?.touched || newForm.get('fechaAproxEntrega')?.dirty),
              'is-valid': newForm.get('fechaAproxEntrega')?.valid && newForm.get('fechaAproxEntrega')?.dirty
            }">
              <div *ngIf="newForm.get('fechaAproxEntrega')?.errors?.['required']" class="invalid-feedback">
                Este campo es obligatorio.
              </div>
              <div *ngIf="newForm.get('fechaAproxEntrega')?.errors?.['fechaPasada']" class="invalid-feedback">
                Fecha inválida.
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <div class="form-group">
              <label for="exampleFormControlInput1">Contenido del paquete<b style="color: red;">*</b></label>
              <textarea class="form-control" formControlName="contenidoPaquete" [ngClass]="{
                'is-invalid': newForm.get('contenidoPaquete')?.invalid && (newForm.get('contenidoPaquete')?.touched || newForm.get('contenidoPaquete')?.dirty),
                'is-valid': newForm.get('contenidoPaquete')?.valid && newForm.get('contenidoPaquete')?.dirty
              }"></textarea>
              <div *ngIf="newForm.get('contenidoPaquete')?.errors?.['required']" class="invalid-feedback">
                Este campo es obligatorio.
              </div>
            </div>
          </div>
        </div>

        <button type="button" mat-raised-button color='accent' (click)="goBack()">Atrás</button> |
        <button type="submit" mat-raised-button color="primary" [disabled]="newForm.invalid">Guardar</button>
        <br><br>
      </form>
    </div>
  </div>
</app-navigation>